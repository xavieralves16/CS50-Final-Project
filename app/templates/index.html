{% extends "base.html" %}
{% block content %}
<h1>Available Products</h1>

{% if is_admin %}
  <a href="{{ url_for('products.add_product') }}">Add New Product</a>
{% endif %}

<!-- Product container -->
<div id="product-list" data-is-admin="{{ is_admin | tojson }}"></div>

<script>
  // Flag vinda do Flask (sem erros no VS Code)
  const IS_ADMIN = JSON.parse(
    document.getElementById("product-list").dataset.isAdmin
  );

  // Fetch products from Flask backend
  function loadProducts() {
    fetch("/products/all")
      .then(response => response.json())
      .then(data => {
        const list = document.getElementById("product-list");
        list.innerHTML = ""; // Clear before adding

        data.forEach(product => {
          const card = document.createElement("div");
          card.className = "product-card";

          // Product info
          let html = `
            <h3>${product.name}</h3>
            <p><strong>Price:</strong> $${product.price}</p>
          `;

          if (product.description) {
            html += `<p>${product.description}</p>`;
          }

          if (product.image_url) {
            html += `<img src="${product.image_url}" alt="${product.name}" class="product-image">`;
          } else {
            html += `<img src="https://via.placeholder.com/150" alt="placeholder" class="product-image">`;
          }

          // Delete button only if admin
          if (IS_ADMIN) {
            html += `<button onclick="deleteProduct(${product.id})">Delete</button>`;
          }
          html += `<button onclick="addToCart(${product.id})">Add to Cart</button>`;
          card.innerHTML = html;
          list.appendChild(card);
        });
      });
  }

  // Delete a product by ID
  function deleteProduct(productId) {
    fetch(`/products/delete/${productId}`, { method: "POST" })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
        } else {
          alert(data.message);
          loadProducts(); // refresh
        }
      });
  }

  // Add product to cart
  function addToCart(productId) {
    fetch(`/cart/add/${productId}`, { method: 'POST' })
      .then(async res => {
        const data = await res.json();
        if (!res.ok) {
          if (data.error) {
            alert(data.error);
          }
          return;
        }
        let totalItems = 0;
        for (const qty of Object.values(data.cart)) {
          totalItems += qty;
        }
        document.getElementById('cart-count').textContent = totalItems;
        if (data.message) {
          console.log(data.message);
        }
      })
      .catch(error => console.error('Error adding to cart:', error));
  }

  // Load products on page load
  loadProducts();
</script>
{% endblock %}



